{% extends "DataHub/base.html" %}
{% block content %}

<div class="content mt-3">

    <div class="row m-2 ">
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-7">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">3 Top Product</p>
                                <h5 class="font-weight-bolder">$53,000</h5>
                                {{ top3Product }}
                                nogg
                                <span class="text-success text-sm font-weight-bolder">+ $4,000</span>
                                <span class="text-success text-sm font-weight-bolder">+ $2,000</span>
                                <span class="text-sm">more</span>
                            </div>
                        </div>
                        <div class="col-5 text-end my-auto">
                            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                <i class="ni ni-money-coins text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-7">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Today's Users</p>
                                <h5 class="font-weight-bolder">2,300</h5>
                                <span class="text-success text-sm font-weight-bolder">+ 5,3%</span>
                            </div>
                        </div>
                        <div class="col-5 text-end my-auto">
                            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                <i class="ni ni-world text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-7">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">New Clients</p>
                                <h5 class="font-weight-bolder">+3,462</h5>
                                <span class="text-success text-sm font-weight-bolder">+ 94</span>
                                <span class="text-sm">last week</span>
                            </div>
                        </div>
                        <div class="col-5 text-end my-auto">
                            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                <i class="ni ni-paper-diploma text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-sm-6">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-7">
                            <div class="numbers">
                                <p class="text-sm mb-0 text-capitalize font-weight-bold">Sales</p>
                                <h5 class="font-weight-bolder">$103,430</h5>
                                <span class="text-success text-sm font-weight-bolder">+ 5.3%</span>
                            </div>
                        </div>
                        <div class="col-5 text-end my-auto">
                            <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                                <i class="ni ni-cart text-lg opacity-10" aria-hidden="true"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div>
            <p>------------STATS CLIENT-------------</p>
            <p>Client ID : {{ clientID }}</p>
        </div>
        <div class="row">
            <div class="col border rounded mx-1">
                <p class="text-center">
                    Votre Nombre d'achats par Mois
                </p>
                <canvas id="myChart" class="mb-2"> </canvas>
            </div>
            <div class="col border rounded mx-1">
                <p class="text-center">
                    Votre Nombre d'achats par Mois
                </p>
                <canvas id="myChartLineChart" class="mb-2"> </canvas>
            </div>
            <div class="col border rounded mx-1">
                <p class="text-center">
                    Votre Nombre d'achats au mois avec Mailles
                </p>
                <canvas id="myChartMailles" class="mb-2"> </canvas>
            </div>
        </div>
        <!--
            <p>---------------GENERAL---------------<p>
            <p>
                Total d'articles commandés : {{clientTotal}}<br/>
                Total dépensé : {{clientSumPrice}}<br/>
                Mois de prédilections : {{bestMois}} - {{totalBestMois}} articles commandés<br/>
                Article le plus chère : {{clientMaxArticle}} - {{clientMaxPrice}}€ - {{maxArticleOccurences}} achats<br/>
                Article le moins chère : {{clientMinArticle}} - {{clientMinPrice}}€ - {{minArticleOccurences}} achats<br/>
                Nombre de commandes : {{nombreCommandes}}<br/>
                Prix moyen des articles commandés : {{clientMeanPrice}}€<br/>
                Nombre d'article par commande en moyenne : {{nbParCommande}}<br/>
            </p>
        <div>
            <p>---------MEILLEURE COMMANDE---------<p>
            <p>
                Plus grosse commande : {{bestCommande}} - Mois : {{monthBestCommande}}<br/>
                {{nbBestCommande}} articles - {{priceBestCommande}}€<br/>
            </p>
        </div>
        <div>
            <p>--------MEILLEURES CATEGORIES--------<p>
            <p>
                Famille la plus commandée : {{bestFamille}} - {{totalBestFamille}} articles<br/>
                Univers le plus commandé : {{bestUnivers}} - {{totalBestUnivers}} articles<br/>
                Maille la plus commandée : {{bestMaille}} - {{totalBestMaille}} articles<br/>
                Article le plus commandé : {{bestArticle}} - {{totalBestArticle}} articles<br/>
            </p>
        </div>
        -->
    </div>

    <div class="card m-4 p-4">
        <table id="example" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Commande</th>
                    <th>Mois</th>
                    <th>Articles</th>
                    <th>Prix</th>
                </tr>
            </thead>
            <tbody>
                {% for commande in commandesClient %}
                <tr>
                    <td>{{ commande.TICKET_ID }}</td>
                    <td>{{ commande.MOIS_VENTE }}</td>
                    <td>{{ commande.NOMBRE_ARTICLES }}</td>
                    <td>{{ commande.PRIX_TOTAL }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>



<script>

    $(document).ready(function () {
        $('#example').DataTable();
    });
    var CommandesClient = "{{ CommandesClient|safe }}";

    var myTable = $('#example').DataTable({
        "paging": true,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": true,
    });

    let top3Product = JSON.parse(`{{ bestTop3ProductNyClient | safe }}`);
    console.log("Here =>", top3Product);
    Object.entries(top3Product).map(([key, value]) => {
        console.log("Insideee =>", key, "Value", value);
    });
    const ctx = document.getElementById('myChart');
    const ctxLineChart = document.getElementById('myChartLineChart');
    const ctxMailleChart = document.getElementById('myChartMailles');
    var a = `{{totalByMonth|safe}}`;
    const JanuaryUserBought = a[1];
    const FebruaryUserBought = a[2];
    const MarchUserBought = a[3];
    const AprilUserBought = a[4];
    const MayUserBought = a[5];
    const JuneUserBought = a[6];
    const JulyUserBought = a[7];
    const AugustUserBought = a[8];
    const SeptemberUserBought = a[9];
    const OctoberUserBought = a[10];
    const NovemberUserBought = a[11];
    const DecemberUserBought = a[12];
    const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [{
                label: '# of Purchases',
                data: [JanuaryUserBought, FebruaryUserBought, MarchUserBought, AprilUserBought, MayUserBought, JuneUserBought, JulyUserBought, AugustUserBought, SeptemberUserBought, OctoberUserBought, NovemberUserBought, DecemberUserBought],
                backgroundColor: [
                    'rgba(21, 119, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(21, 119, 64, 0.2)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    grid: {
                        display: false,
                    },
                },
                y: {
                    grid: {
                        display: false,
                    },
                    beginAtZero: true
                }
            }
        }
    }); myChartMailles

    const myChartLineChart = new Chart(ctxLineChart, {
        type: 'line',
        data: {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [{
                label: '# of Purchases',
                data: [JanuaryUserBought, FebruaryUserBought, MarchUserBought, AprilUserBought, MayUserBought, JuneUserBought, JulyUserBought, AugustUserBought, SeptemberUserBought, OctoberUserBought, NovemberUserBought, DecemberUserBought],
                backgroundColor: [
                    'rgba(21, 119, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(21, 119, 64, 0.2)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                x: {
                    grid: {
                        display: false,
                    },
                },
                y: {
                    grid: {
                        display: false,
                    },
                    beginAtZero: true
                }
            }
        }
    });
    const arrayObjMaillesByCli = JSON.parse(`{{ totalByMailleByClient|safe }}`);
    let object = {};
    let arrayObjMaillesByMonths = JSON.parse(`{{ totalByMonthByMaille|safe }}`);

    let JanuaryUserBoughtMail0 = 0;
    let FebruaryUserBoughtMail0 = 0;
    let MarchUserBoughtMail0 = 0;
    let AprilUserBoughtMail0 = 0;
    let MayUserBoughtMail0 = 0;
    let JuneUserBoughtMail0 = 0;
    let JulyUserBoughtMail0 = 0;
    let AugustUserBoughtMail0 = 0;
    let SeptemberUserBoughtMail0 = 0;
    let OctoberUserBoughtMail0 = 0;
    let NovemberUserBoughtMail0 = 0;
    let DecemberUserBoughtMail0 = 0;
    let mailData = [
        // "Fruits",
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0
    ]
    arrayObjMaillesByCli.forEach((key) => {
        object[key] = {
            "January": 0, "February": 0, "March": 0, "April": 0, "May": 0, "June": 0, "July": 0, "August": 0, "September": 0,
            "October": 0, "November": 0, "December": 0
        };
        arrayObjMaillesByMonths.index.forEach((keyb, idxb) => {
            arrayObjMaillesByMonths.data.forEach((keya, idxa) => {
                if (idxa === idxb) {
                    switch (keyb[0]) {
                        case 1:
                            if (keyb[1] == key) {
                                object[keyb[1]]["January"] = object[keyb[1]]["January"] + keya;
                            }
                            break;
                        case 2:
                            if (keyb[1] == key) {
                                object[keyb[1]]["February"] = object[keyb[1]]["February"] + keya;
                            }
                            break;
                        case 3:
                            if (keyb[1] == key)
                                object[keyb[1]]["March"] = object[keyb[1]]["March"] + keya;
                            break;
                        case 4:
                            if (keyb[1] == key) {
                                object[keyb[1]]["April"] = object[keyb[1]]["April"] + keya;
                            }
                            break;
                        case 5:
                            if (keyb[1] == key) {
                                object[keyb[1]]["May"] = object[keyb[1]]["May"] + keya;
                            }
                            break;
                        case 6:
                            if (keyb[1] == key) {
                                object[keyb[1]]["June"] = object[keyb[1]]["June"] + keya;
                            }
                            break;
                        case 7:
                            if (keyb[1] == key) {
                                object[keyb[1]]["July"] = object[keyb[1]]["July"] + keya;
                            }
                            break;
                        case 8:
                            if (keyb[1] == key) {
                                object[keyb[1]]["August"] = object[keyb[1]]["August"] + keya;
                            }
                            break;
                        case 9:
                            if (keyb[1] == key) {
                                object[keyb[1]]["September"] = object[keyb[1]]["September"] + keya;
                            }
                            break;
                        case 10:
                            if (keyb[1] == key) {
                                object[keyb[1]]["October"] = object[keyb[1]]["October"] + keya;
                            }
                            break;
                        case 11:
                            if (keyb[1] == key) {
                                object[keyb[1]]["November"] = object[keyb[1]]["November"] + keya;
                            }
                            break;
                        case 12:
                            if (keyb[1] == key) {
                                object[keyb[1]]["December"] = object[keyb[1]]["December"] + keya;
                            }
                            break;
                        default:
                            object[keyb[1]]["December"] = object[keyb[1]]["December"] + keya;
                            break;
                    }
                }
            });
        });
    });

    let datasetchartmaille = [];
    datasetchartmaille = [
        {
            label: '# of Purchases by Fruits',
            data: mailData,
            backgroundColor: [
                'rgba(93, 251, 0, 0.2)'
            ],
            borderColor: [
                'rgba(35, 122, 192, 0.2)'
            ],
            borderWidth: 1
        },
    ];

    Object.entries(object).map(([key, value]) => {
        mailData[0] = value.January;
        mailData[1] = value.February;
        mailData[2] = value.March;
        mailData[3] = value.April;
        mailData[4] = value.May;
        mailData[5] = value.June;
        mailData[6] = value.July;
        mailData[7] = value.August;
        mailData[8] = value.September;
        mailData[9] = value.October;
        mailData[10] = value.November;
        mailData[11] = value.December;

        datasetchartmaille.push({
            label: '# of Purchases by ' + key,
            data: [mailData[0], mailData[1], mailData[2], mailData[3], mailData[4], mailData[5], mailData[6], mailData[7], mailData[8], mailData[9], 
            mailData[10], mailData[11]  ],
            backgroundColor: [
                'rgba(' + Math.floor(Math.random() * 255) +','+ Math.floor(Math.random() * 255) +',' +Math.floor(Math.random() * 255) + ', 0.2)'
            ],
            borderColor: [
                'rgba(' + Math.floor(Math.random() * 255) +','+ Math.floor(Math.random() * 255) +',' +Math.floor(Math.random() * 255) + ', 0.2)'
            ],
            borderWidth: 1
        });
    });

    const myChartMaillesChart = new Chart(ctxMailleChart, {
        type: 'bar',
        data: {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: datasetchartmaille
        },
        options: {
            scales: {
                x: {
                    grid: {
                        display: false,
                    },
                    stacked: true
                },
                y: {
                    grid: {
                        display: false,
                    },
                    beginAtZero: true,
                    stacked: true
                }
            }
        }
    });
    // myChart.canvas.parentNode.style.height = '100%';
    // myChart.parentNode.backgroundColor = 'white';
    // myChart.canvas.style.height = '70%';
    // myChart.canvas.style.width = '70%';
    myChart.canvas.style.backgroundColor = '#FFF';
    myChartLineChart.canvas.style.backgroundColor = '#FFF';
    myChartMaillesChart.canvas.style.backgroundColor = '#FFF';

</script>

{% endblock %}